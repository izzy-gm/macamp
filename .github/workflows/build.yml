name: Build and Release

on:
  push:
    branches:
      - main
      - 'feature/**'
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: macos-14
    permissions:
      contents: write
    # Skip workflow for version bump commits
    if: |
      github.event.head_commit == null ||
      (!contains(github.event.head_commit.message, '[skip ci]') &&
       !contains(github.event.head_commit.message, '[ci skip]'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.0'

      - name: Extract and bump version
        id: get_version
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "üîÑ Bumping version for main branch..."
            chmod +x ./bump-version.sh
            ./bump-version.sh patch
            VERSION=$(grep -A 1 "MARKETING_VERSION" "MacAmp.xcodeproj/project.pbxproj" | grep -oE "[0-9]+\.[0-9]+(\.[0-9]+)?" | head -n 1)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "üì¶ Bumped version to: $VERSION"
          else
            echo "üìã Extracting version for feature branch..."
            VERSION=$(grep -A 1 "MARKETING_VERSION" "MacAmp.xcodeproj/project.pbxproj" | grep -oE "[0-9]+\.[0-9]+(\.[0-9]+)?" | head -n 1)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "üì¶ Current version: $VERSION"
          fi

      - name: Build application
        run: |
          chmod +x ./build.sh
          ./build.sh --release

      - name: Find built app
        id: find_app
        run: |
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData/MacAmp-*/Build/Products/Release/MacAmp.app -maxdepth 0 2>/dev/null | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå Could not find built application!"
            exit 1
          fi
          echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT
          echo "‚úÖ Found app at: $APP_PATH"
          ls -la "$APP_PATH"

      - name: Create DMG
        env:
          SKIP_BUILD: "true"
          BUILD_OUTPUT_DIR: "${{ steps.find_app.outputs.app_path }}"
        run: |
          chmod +x ./create-dmg.sh
          ./create-dmg.sh "${{ steps.get_version.outputs.version }}"
          ls -la release/

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: MacAmp-${{ steps.get_version.outputs.version }}.dmg
          path: release/MacAmp-${{ steps.get_version.outputs.version }}.dmg
          retention-days: 30

      - name: Check if tag exists
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.get_version.outputs.version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag v${{ steps.get_version.outputs.version }} already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Tag v${{ steps.get_version.outputs.version }} does not exist"
          fi

      - name: Commit version bump (main branch only)
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if version was bumped (compare with what was checked out)
          git fetch origin main || true
          if git diff HEAD MacAmp.xcodeproj/project.pbxproj | grep -q "MARKETING_VERSION"; then
            git add MacAmp.xcodeproj/project.pbxproj
            VERSION="${{ steps.get_version.outputs.version }}"
            git commit -m "Bump version to $VERSION [skip ci]"
            git push origin main
            echo "‚úÖ Version bump committed and pushed"
          else
            echo "‚ÑπÔ∏è  No version changes to commit"
          fi

      - name: Create tag and release (main branch only)
        if: github.ref == 'refs/heads/main' && steps.check_tag.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          TAG="v${VERSION}"

          # Create and push tag
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

          # Create GitHub release
          gh release create "$TAG" \
            --title "MacAmp $TAG" \
            --notes "Release $TAG - Built from commit ${{ github.sha }}" \
            "release/MacAmp-${VERSION}.dmg"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

